{% extends "base.html" %}


{% block css_block %}
<!-- API css -->
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/api.css') }}">

<style type="text/css">
	code {
		font-family: Consolas,"courier new";
		background-color: #f1f1f1;
		display: block;
		padding: 20px;
	}
</style>
{% endblock %}

{% block middle_nav_options %}
{% endblock %}

{% block additional_navs %}
{% endblock %}

{% block content %}
<div class="api-container">
	<div class="api-section">
		<h3>API Doc</h3>
		<a class="anchor" href="#introduction">Introduction</a>
		<a class="anchor" href="#app-creation">Creating an App</a>
		<a class="anchor" href="#authorization">Authorization</a>
		<a class="anchor" href="#authorization-code-flow">Authorization Code flow example</a>
	</div>
	<div class="api-content">
		<h1>API</h1>
		<section id="introduction">
			<h2>Introduction</h2>
			<p>
				This is version 1.0 of the API and is a RESTful API based on HTTP requests and JSON responses. It gives the user the ability to do many of the functionalities that they would be able to do on the website through various API endpoints.
			</p>
			<p>
				It uses <a href="https://datatracker.ietf.org/doc/html/rfc6749" target="_blank">OAuth 2.0</a> which means all requests will need to be encrypted and sent via HTTPS for security reasons. This allows anyone to programatically use the API endpoints to perform any operation that they could have performed on the website.
			</p>
		</section>

		<section id="app-creation">
			<h2>Creating an App/Registration</h2>
			<p>
				Before you can begin, using the API you will need to first <a href="{{ url_for('api.create_client') }}" target="_blank">register</a> a new application (Client) with server. When registering a new app you need to enter a valid application name and chose an token endpoint authentication method that will determine how authorization request will be performed. Once submitted you will be presented with details of the client including client_id and possibly client_secret, note them down or you can view a list of applications created in the application tab <a href="{{ url_for('imager.settings') }}#application" target="_blank">here</a>.
			</p>
			<p>
				The grant type that the application will use by default is the <b>Authorization Code</b>. This is may require a redirect URI to be used to redirect the Resource owner (User) to the Authorization Server which after submiting response will redirect the user back to the client with the authorized code.

				Then there's the client authentication methods, this determines how the client will communicate with the authorization server after the app is created. After creating an app, two tokens will be created <b>client_id</b> and possibly a <b>client_secret</b> if not none. They include the following options:
				<ol>
					<li><b>client_secret_post</b>:Both client_id and client_secret tokens are required to be presented as a parameter of any request to the Authorization server where they'll be checked if they're valid for that specific client.
					</li>

					<li><b>client_secret_basic</b>:
						Here a string is created joining the client_id and client_secret for example: "{client_id}:{client_secret}". Next the string will be encoded with <a href="https://tools.ietf.org/html/rfc4648" target="_blank">BASE64</a>. Finally, embed the BASE64 encoded string in the Authorization header in a token request for example: Authorization: Basic {BASE64-encoded Credentials}
					</li>

					<li><b>none</b>: Client authentication is not required so any request will go through.</li>
				</ol>
			</p>
		</section>

		<section id="authorization">
			<h2>Authorization</h2>
			<p>
				Once the application is registered, the service will issue client credentials in the form of a <b>client_id</b> and a <b>client_secret</b>. client_id is a publicly exposed string that's used by the service API to identify the application, and is also used to build authorization URLs that are presented to users. The client_secret however is used to authenticate the identity of the application to the service API when the application requests to access a user's account, and must be kept private between the application and the API.
			</p>

			<p>
				Using the client_id and possibly the client_secret the client requires to obtain the following before being able to access the resource server(API):
				<ul>
					<li>
						<b>Access Token</b>
					</li>
					<p>
						The access token is required for any client request to be able to  successfully access protected resources from the resource source(API), and will need to be embeded in any request's header. The access token is expected to expire after a period of time.
					</p>

					<li>
						<b>Refresh Token</b>
					</li>
					<p>
						The refresh token is used to obtain new access tokens once the access tokens have expired, where it is long lasting.
					</p>
				</ul>
			</p>

			<p>
				The following steps are needed in the case where an <b>Authorization grant type</b> is used for a client to be authorized to access the resource server (API):
				<ol>
					<li>The client requests authorization to access service resources from the user.</li>
					<li>If the user authorized the request, the application receives an authorization grant.</li>
					<li>The client requests an access token from the authorization server by presenting authentication of its own identity, and the authorization grant</li>
					<li>If the application identity is authenticated and the authorization grant is valid, the authorization server issues an access token to the client. Authorization is complete.</li>
					<li>The client requests the resource from the resource server (API) and presents the access token for authentication.</li>
					<li>If the access token is valid, the resource server(API) serves the resource to the client.</li>
				</ol>
			</p>
		</section>

		<section id="authorization-code-flow">
			<h2>Authorization Code flow example</h2>
			
			<p>
				An example of the various steps one has to perform to be able to utilize the API endpoints include:
				<ol>
					<li>After having registered an application from the <a href="#app-creation">previous section</a>, note the <b>client_id</b> of the app.</li>
					<li>Open a new tab/window and enter the following, replace '${}' with appropriate values:</li>
					<code>
						${Domain-Name}/api/v1/oauth/authorize?response_type=code&client_id=${client_id}
					</code>
					<li>This will take the user to an authorization page, where they will have to grant authorization to the client.</li>
					<li>After granting authorization, the user will be redirected to <code>${redirect_uri}/?code=${code}</code>If no redirect_uri was specified the redirect will by default go to the homepage. Note down the code as this is the authorization code needed to obtain an <b>access_token</b> from the Authorization Server.</li>
					<li>
						To get an access token, you will need to make a POST request, where you use the <b>client_id</b> and/or <b>client_secret</b> as authentication as discussed in the <a href="#app-creation">previous section</a>. An example of this using <strong>cURL</strong> and with the application using <strong>client_secret_post</strong> token enpoint authentication method. Replace '${}' with appropriate values.
						<code>
							$ curl -u ${client_id}:${client_secret} -XPOST ${Domain-Name}/oauth/token -F grant_type=authorization_code -F code=${code}
						</code>
					</li>
					<li>
						The output of the previous command should provide a JSON response with an access_token, including additional information such <strong>expires_in</strong> and <strong>token_type</strong>. You will now be able to access most API endpoints by embeding the access token in any request's header i.e <code>Authorization: Bearer ${access_token}</code>.
					</li>
					<li>
						An example of accessing an API endpoint using cURL would be:
						<code>
							$ curl -H "Authorization: Bearer ${access_token}" ${Domain-Name}/api/v1/${API-Endpoint}
						</code>
					</li>
				</ol>
			</p>
		</section>
	</div>
</div>

{% endblock %}